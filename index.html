<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#667eea">
<title>Dehjiluxe Business Manager</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;overflow-x:hidden}
.hidden{display:none!important}
.gradient-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh}
.container{max-width:640px;margin:0 auto;padding:1rem;padding-bottom:80px}
.header{color:#fff;margin-bottom:1.5rem}
.header h1{font-size:1.875rem;font-weight:700;margin-bottom:.25rem}
.header p{opacity:.9;font-size:.875rem}
.back-btn{display:inline-flex;align-items:center;color:#fff;font-size:1.5rem;background:none;border:none;cursor:pointer;padding:.5rem;margin:-.5rem .5rem -.5rem -.5rem}
.card{background:#fff;border-radius:.75rem;padding:1rem;margin-bottom:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
.card h2{font-size:1.125rem;font-weight:700;color:#1f2937;margin-bottom:.75rem}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:1.5rem}
.stat-card{background:#fff;border-radius:.75rem;padding:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
.stat-card p:first-child{color:#6b7280;font-size:.875rem}
.stat-card p:last-child{font-size:1.5rem;font-weight:700;margin-top:.25rem}
.btn{display:block;width:100%;padding:1rem;border:none;border-radius:.75rem;font-weight:700;font-size:1rem;cursor:pointer;transition:all .2s;margin-bottom:.5rem}
.btn-primary{background:#8b5cf6;color:#fff}
.btn-primary:active{background:#7c3aed}
.btn-secondary{background:#f3f4f6;color:#374151}
.btn-white{background:#fff;color:#8b5cf6}
.btn-green{background:#10b981;color:#fff}
.btn-blue{background:#3b82f6;color:#fff}
.btn-sm{padding:.5rem;font-size:.875rem}
.action-card{background:#fff;border-radius:.75rem;padding:1rem;margin-bottom:.75rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:all .2s}
.action-card:active{background:#faf5ff}
.action-content{display:flex;align-items:center;flex:1}
.action-icon{font-size:2rem;margin-right:.75rem}
.action-text h3{font-weight:700;color:#1f2937;font-size:1rem}
.action-text p{color:#6b7280;font-size:.875rem}
.action-arrow{color:#8b5cf6;font-size:1.25rem}
.form-group{margin-bottom:1rem}
.form-label{display:block;color:#6b7280;font-size:.875rem;margin-bottom:.25rem}
.form-input{width:100%;padding:.75rem;border:1px solid #d1d5db;border-radius:.5rem;font-size:1rem}
.form-input:focus{outline:none;border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,.1)}
select.form-input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");background-position:right .5rem center;background-repeat:no-repeat;background-size:1.5em 1.5em;padding-right:2.5rem}
.tabs{display:flex;gap:.25rem;margin-bottom:1rem}
.tab{flex:1;padding:.5rem;border:none;border-radius:.5rem;background:#f3f4f6;color:#6b7280;font-weight:600;font-size:.875rem;cursor:pointer}
.tab.active{background:#8b5cf6;color:#fff}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #e5e7eb;display:flex;justify-content:space-around;padding:.75rem 1rem;z-index:50}
.nav-item{display:flex;flex-direction:column;align-items:center;background:none;border:none;cursor:pointer;color:#9ca3af;font-size:.75rem}
.nav-item.active{color:#8b5cf6}
.nav-icon{font-size:1.5rem;margin-bottom:.25rem}
.result-card{background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border-radius:.75rem;padding:1.5rem;color:#fff;box-shadow:0 10px 15px -3px rgba(139,92,246,.4);margin-bottom:1rem}
.result-card p:first-child{opacity:.9;font-size:.875rem;margin-bottom:.25rem}
.result-card .big-number{font-size:2.5rem;font-weight:700;margin-bottom:1rem}
.result-details{padding-top:1rem;border-top:1px solid rgba(255,255,255,.2)}
.result-row{display:flex;justify-content:space-between;margin-bottom:.5rem;font-size:.875rem}
.result-row span:first-child{opacity:.75}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem}
.badge{display:inline-block;padding:.25rem .5rem;border-radius:.25rem;font-size:.75rem;font-weight:600}
.badge-orange{background:#fed7aa;color:#c2410c}
.badge-green{background:#bbf7d0;color:#15803d}
.alert{padding:1rem;border-radius:.5rem;margin-bottom:1rem;border-left:4px solid}
.alert-warning{background:#fef3c7;border-color:#f59e0b;color:#92400e}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:40}
.more-menu{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:1rem 1rem 0 0;padding:1rem;z-index:50;box-shadow:0 -10px 15px -3px rgba(0,0,0,.1)}
.more-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem}
.more-item{display:flex;flex-direction:column;align-items:center;padding:1rem;border-radius:.75rem;background:none;border:none;cursor:pointer}
.more-item:active{background:#f3f4f6}
.more-item span:first-child{font-size:2rem;margin-bottom:.5rem}
.more-item span:last-child{font-size:.75rem;font-weight:600;color:#1f2937}
</style>

</head>
<body>
<div id="app"></div>
<script>
"use strict";

// Storage
const S={
save:(k,d)=>{try{localStorage.setItem(k,JSON.stringify(d));return true}catch(e){return false}},
load:(k,d=null)=>{try{const x=localStorage.getItem(k);return x?JSON.parse(x):d}catch(e){return d}}
};

// State
const DS={usdToCad:1.45,nairaPerCad:1000};
const DC={qc:12,packaging:4,contingency:0.03,customsConservative:27,nigeriaConstruction:20000,nigeriaDHL:81000,nigeriaPickup:3500,chinaShipping:35,vietnamShipping:65};
const App={
screen:'dashboard',
settings:S.load('settings',{exchangeRates:DS,defaultCosts:DC}),
calcs:S.load('calculations',[]),
invs:S.load('invoices',[]),
inv:S.load('inventory',{bundles:[],closures:[],finishedWigs:[],transactions:[]}),
showMore:false,
calc:{productType:'custom',source:'china',batchSize:4,productName:'',materialsPrice:'',materialsCurrency:'usd',customNairaRate:'',shippingCost:'',customsCost:'',qcCost:'',packagingCost:'',restylingCost:0,constructionCost:'',result:null},
mixedBatch:{items:[],sharedCosts:{shipping:'',customs:'',source:'china'},result:null},
nav(s){this.screen=s;this.showMore=false;render()},
save(){S.save('settings',this.settings);S.save('calculations',this.calcs);S.save('invoices',this.invs);S.save('inventory',this.inv)}
};

// Utilities
const $=(s)=>document.querySelector(s);
const fmt=(v)=>'$'+parseFloat(v).toFixed(2);
const fmtD=(d)=>new Date(d).toLocaleDateString();

// Calculator
function calcCost(){
if(!checkDuplicate())return;
const s=App.settings,c=App.calc;
if(!c.materialsPrice){alert('Enter materials price');return}

// Validate batch size
if(!c.batchSize || c.batchSize < 1){
alert('‚ùå Batch size must be at least 1');
return;
}

// Validate materials price is a number
const materialsPriceNum = parseFloat(c.materialsPrice);
if(isNaN(materialsPriceNum) || materialsPriceNum <= 0){
alert('‚ùå Invalid materials price');
return;
}

let t=0,b={};
let m=0;
if(c.materialsCurrency==='usd')m=materialsPriceNum*s.exchangeRates.usdToCad;
else if(c.materialsCurrency==='naira')m=materialsPriceNum/(c.customNairaRate||s.exchangeRates.nairaPerCad);
else m=materialsPriceNum;

// For bundles and factory wigs, materials price is for the entire batch
// For custom wigs, materials price is per wig
if(c.productType==='bundles' || c.productType==='factory'){
b.materials=m/c.batchSize;
t+=m/c.batchSize;
}else{
b.materials=m;
t+=m;
}

if(c.productType==='custom'){
const co=parseFloat(c.constructionCost||s.defaultCosts.nigeriaConstruction)/s.exchangeRates.nairaPerCad;
b.construction=co;t+=co;
const dhl=s.defaultCosts.nigeriaDHL/s.exchangeRates.nairaPerCad/c.batchSize;
b.dhl=dhl;t+=dhl;
const p=s.defaultCosts.nigeriaPickup/s.exchangeRates.nairaPerCad/c.batchSize;
b.pickup=p;t+=p;
}else{
// Shipping costs are in USD, need to convert to CAD
let shippingUSD;
if(c.shippingCost){
// User entered custom shipping - assume it's in USD
shippingUSD = parseFloat(c.shippingCost);
}else{
// Use default shipping (in USD)
shippingUSD = c.source==='vietnam'?s.defaultCosts.vietnamShipping:s.defaultCosts.chinaShipping;
}
const sh = shippingUSD * s.exchangeRates.usdToCad;
b.shipping=sh/c.batchSize;t+=sh/c.batchSize;
}
const cu=parseFloat(c.customsCost||s.defaultCosts.customsConservative)/c.batchSize;
b.customs=cu;t+=cu;
const qc=parseFloat(c.qcCost||s.defaultCosts.qc);
b.qc=qc;t+=qc;
if(c.restylingCost>0){b.restyling=parseFloat(c.restylingCost);t+=parseFloat(c.restylingCost)}
const pk=parseFloat(c.packagingCost||s.defaultCosts.packaging);
b.packaging=pk;t+=pk;
const ct=t*s.defaultCosts.contingency;
b.contingency=ct;t+=ct;
c.result={trueCost:t,breakdown:b};
autoSaveCalc();
render();
}

function saveCalc(){
if(!App.calc.result)return;
const priceAt50=App.calc.result.trueCost/0.5;
const profitAt50=priceAt50-App.calc.result.trueCost;
const ca={
id:Date.now(),
date:new Date().toISOString(),
exchangeRates:{
usdToCad:App.settings.exchangeRates.usdToCad,
nairaPerCad:App.settings.exchangeRates.nairaPerCad
},
name:App.calc.productName||'Unnamed',
description:App.calc.productType+' - '+App.calc.source+' - Batch of '+App.calc.batchSize,
productType:App.calc.productType,
source:App.calc.source,
batchSize:App.calc.batchSize,
trueCost:App.calc.result.trueCost,
breakdown:App.calc.result.breakdown,
recommendedPrice50:priceAt50,
estimatedProfit50:profitAt50,
marginUsed:50
};
App.calcs.unshift(ca);
App.save();
alert('‚úÖ Saved with profit data!');
App.nav('dashboard');
}

function shareWA(){
const r=App.calc.result;
const p=(r.trueCost/0.5).toFixed(2);
const m='Hi! Quote from Dehjiluxe:\n\n'+(App.calc.productName||'Custom Product')+'\nüíµ Price: $'+p+'\nüì¶ Shipping: $30\nTotal: $'+(parseFloat(p)+30).toFixed(2)+'\n\nInterested? Let me know! ‚ú®';
window.open('https://wa.me/?text='+encodeURIComponent(m),'_blank');
}

function copyQ(){
const r=App.calc.result;
const q=(App.calc.productName||'Product')+' - TRUE COST: '+fmt(r.trueCost)+' | Selling at 50% margin: '+fmt(r.trueCost/0.5)+' + $30 shipping = '+fmt((r.trueCost/0.5)+30)+' total';
navigator.clipboard.writeText(q).then(()=>alert('‚úÖ Copied!'));
}

// Invoices
let invF={customer:'',email:'',items:[{desc:'',qty:1,price:''}],shipping:30};

function addInvItem(){
invF.items.push({desc:'',qty:1,price:''});
render();
}

function saveInv(){
const vi=invF.items.filter(i=>i.desc&&i.qty&&i.price).map(i=>({description:i.desc,quantity:parseInt(i.qty),unitPrice:parseFloat(i.price),total:parseInt(i.qty)*parseFloat(i.price)}));
if(vi.length===0){alert('Add items');return}
const st=vi.reduce((s,i)=>s+i.total,0);
const inv={id:Date.now(),invoiceNumber:'INV-'+String(App.invs.length+1).padStart(3,'0'),date:new Date().toISOString(),customer:{name:invF.customer,email:invF.email},items:vi,shipping:parseFloat(invF.shipping)||0,subtotal:st,total:st+(parseFloat(invF.shipping)||0),status:'pending'};
App.invs.unshift(inv);App.save();alert('‚úÖ Invoice created!');
invF={customer:'',email:'',items:[{desc:'',qty:1,price:''}],shipping:30};
render();
}

function shareInvWA(inv){
const m='Hi '+inv.customer.name+'! üëã\n\nHere\'s your invoice from Dehjiluxe:\n\nüìÑ '+inv.invoiceNumber+'\nüìÖ '+fmtD(inv.date)+'\n\n'+inv.items.map(i=>'‚Ä¢ '+i.quantity+'√ó '+i.description+' - '+fmt(i.total)).join('\n')+(inv.shipping>0?'\nüöö Shipping - '+fmt(inv.shipping):'')+'\n\nüíµ Total: '+fmt(inv.total)+'\n\nPayment methods: E-transfer, Cash\nDue within 14 days\n\nQuestions? Reply to this message!\n\nThank you! ‚ú®\n- Dehjiluxe';
window.open('https://wa.me/?text='+encodeURIComponent(m),'_blank');
}

function copyInvEmail(inv){
const s='Invoice '+inv.invoiceNumber+' from Dehjiluxe';
const b='Dear '+inv.customer.name+',\n\nThank you for your order! Invoice details:\n\nINVOICE: '+inv.invoiceNumber+'\nDATE: '+fmtD(inv.date)+'\n\nITEMS:\n'+inv.items.map(i=>i.quantity+'√ó '+i.description+' - '+fmt(i.unitPrice)+' each = '+fmt(i.total)).join('\n')+(inv.shipping>0?'\n\nShipping: '+fmt(inv.shipping):'')+'\n\nTOTAL: '+fmt(inv.total)+'\n\nPayment due within 14 days.\nAccepted methods: E-transfer, Cash\n\nBest regards,\nDehjiluxe';
navigator.clipboard.writeText('Subject: '+s+'\n\n'+b).then(()=>alert('‚úÖ Email copied!'));
}

function copyInvSMS(inv){
const m='Hi '+inv.customer.name+'! Your Dehjiluxe invoice '+inv.invoiceNumber+' for '+fmt(inv.total)+' is ready. Payment due in 14 days. E-transfer or cash. Questions? Text back! üíú';
navigator.clipboard.writeText(m).then(()=>alert('‚úÖ SMS copied!'));
}

// Inventory
let invAdd={type:'',length:'',texture:'',quantity:1,cost:'',supplier:''};
let invTab='bundles';

function addInvStock(){
const it={id:Date.now(),...invAdd,dateAdded:new Date().toISOString(),quantity:parseInt(invAdd.quantity),cost:parseFloat(invAdd.cost)};
const tr={id:Date.now(),type:'add',item:it.type,quantity:it.quantity,date:new Date().toISOString(),note:'Added from '+(invAdd.supplier||'supplier')};
App.inv[invTab].push(it);
App.inv.transactions.unshift(tr);
App.save();
invAdd={type:'',length:'',texture:'',quantity:1,cost:'',supplier:''};
render();
}

function useInvStock(id,qty){
App.inv[invTab]=App.inv[invTab].map(i=>{
if(i.id===id){
const nq=Math.max(0,i.quantity-qty);
const tr={id:Date.now(),type:'remove',item:i.type,quantity:qty,date:new Date().toISOString(),note:'Stock removed'};
App.inv.transactions.unshift(tr);
return{...i,quantity:nq}
}
return i
});
App.save();
render();
}

function delInvStock(id){
if(!confirm('Delete item?'))return;
App.inv[invTab]=App.inv[invTab].filter(i=>i.id!==id);
App.save();
render();
}

// Render functions
function render(){
const a=App;
let h='';

if(a.screen==='dashboard'){
const td=new Date().toDateString();
const tdC=a.calcs.filter(c=>new Date(c.date).toDateString()===td);
const tdP=tdC.reduce((s,c)=>s+(c.profit||0),0);
const tm=new Date();
const tmC=a.calcs.filter(c=>{const d=new Date(c.date);return d.getMonth()===tm.getMonth()&&d.getFullYear()===tm.getFullYear()});
const tmP=tmC.reduce((s,c)=>s+(c.profit||0),0);
const pi=a.invs.filter(i=>i.status==='pending').length;
const pendingAmount=a.invs.filter(i=>i.status==='pending').reduce((s,i)=>s+i.total,0);
const oldInvoices=a.invs.filter(i=>{
const age=Math.floor((Date.now()-new Date(i.date).getTime())/86400000);
return i.status==='pending'&&age>10;
}).length;
const ti=Object.keys(a.inv).reduce((t,k)=>{if(Array.isArray(a.inv[k]))return t+a.inv[k].reduce((s,i)=>s+i.quantity,0);return t},0);

h='<div class="gradient-bg"><div class="container"><div class="header"><h1>Dehjiluxe</h1><p>Business Manager</p></div>';
h+='<div class="stats-grid">';
h+='<div class="stat-card"><p>Today\'s Profit</p><p style="color:#10b981">'+fmt(tdP)+'</p></div>';
h+='<div class="stat-card"><p>This Month</p><p style="color:#8b5cf6">'+fmt(tmP)+'</p></div>';
h+='<div class="stat-card"><p>Pending Invoices</p><p style="color:#f59e0b">'+pi+'</p></div>';
h+='<div class="stat-card"><p>Inventory Items</p><p style="color:#3b82f6">'+ti+'</p></div>';
h+='</div>';
if(oldInvoices>0||pendingAmount>500){
h+='<div class="alert alert-warning" style="margin-bottom:1rem">';
h+='<strong>üí∞ Cash Flow Alert</strong><br>';
if(oldInvoices>0){
h+='<span style="font-size:.875rem">'+oldInvoices+' invoice(s) overdue (>10 days)</span><br>';
}
if(pendingAmount>500){
h+='<span style="font-size:.875rem">$'+pendingAmount.toFixed(2)+' in pending payments</span>';
}
h+='</div>';
}
h+='<div class="card"><h2>Quick Actions</h2>';
h+=ac('üßÆ','Calculate Cost','Get TRUE COST for any product','calculator');
h+=ac('üéØ','Mixed Batch','Multiple items in one shipment','mixed');
h+=ac('üì¶','Manage Inventory','Track stock & materials','inventory');
h+=ac('üìÑ','Create Invoice','Generate invoice for customer','invoices');
h+='</div>';
if(a.calcs.length>0){
h+='<div class="card"><h2>Recent Activity</h2>';
a.calcs.slice(0,3).forEach(c=>{
h+='<div style="padding:.75rem 0;border-bottom:1px solid #e5e7eb"><div style="display:flex;justify-content:space-between;margin-bottom:.25rem"><strong>'+(c.name||'Calculation')+'</strong><span style="color:#8b5cf6;font-weight:600">'+fmt(c.trueCost)+'</span></div><p style="font-size:.875rem;color:#6b7280">'+c.description+'</p><p style="font-size:.75rem;color:#9ca3af;margin-top:.25rem">'+fmtD(c.date)+'</p></div>';
});
h+='</div>';
}
h+='</div></div>';
}

else if(a.screen==='calculator'){
const c=a.calc,s=a.settings;
h='<div class="gradient-bg"><div class="container"><div class="header"><button class="back-btn" onclick="App.nav(\'dashboard\')">‚Üê</button><h1>Cost Calculator</h1><p>Calculate TRUE COST</p></div>';
h+='<div class="card"><h2>Quick Presets & Templates</h2><div class="grid-2">';
h+='<button class="btn btn-primary btn-sm" onclick="loadP(\'fringe\')">Fringe Wig</button>';
h+='<button class="btn btn-primary btn-sm" onclick="loadP(\'brown\')">Brown Wig</button>';
h+='</div>';
const templates=S.load('templates',[]);
if(templates.length>0){
h+='<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid #e5e7eb">';
h+='<p style="font-size:.875rem;font-weight:600;color:#374151;margin-bottom:.5rem">üìã Your Saved Templates</p>';
templates.forEach(t=>{
h+='<div style="display:flex;gap:.5rem;margin-bottom:.5rem;align-items:center">';
h+='<button class="btn btn-secondary btn-sm" style="flex:1;text-align:left;font-size:.875rem" onclick="loadTemplate('+t.id+')">'+t.name+'</button>';
h+='<button onclick="deleteTemplate('+t.id+')" style="background:#fee2e2;color:#dc2626;border:none;padding:.5rem;border-radius:.5rem;cursor:pointer;font-size:1rem">üóëÔ∏è</button>';
h+='</div>';
});
h+='</div>';
}
h+='</div>';
h+='<div class="card"><h2>Product Type</h2>';
h+='<select class="form-input" onchange="App.calc.productType=this.value;if(this.value===\'custom\')App.calc.source=\'nigeria\';render()">';
h+='<option value="custom"'+(c.productType==='custom'?' selected':'')+'>Custom-Made (Nigeria)</option>';
h+='<option value="factory"'+(c.productType==='factory'?' selected':'')+'>Factory-Made</option>';
h+='<option value="bundles"'+(c.productType==='bundles'?' selected':'')+'>Bundles Only</option>';
h+='</select></div>';
if(c.productType!=='custom'){
h+='<div class="card"><h2>Source</h2><div class="grid-2">';
h+='<button class="btn '+(c.source==='china'?'btn-primary':'btn-secondary')+'" onclick="App.calc.source=\'china\';render()">üá®üá≥ China<br><small>$35</small></button>';
h+='<button class="btn '+(c.source==='vietnam'?'btn-primary':'btn-secondary')+'" onclick="App.calc.source=\'vietnam\';render()">üáªüá≥ Vietnam<br><small>$65</small></button>';
h+='</div></div>';
}
h+='<div class="card"><h2>Batch Size</h2>';
h+='<div class="grid-2" style="margin-bottom:.5rem">';
h+='<select class="form-input" onchange="if(this.value===&apos;custom&apos;){document.getElementById(&apos;customBatch&apos;).style.display=&apos;block&apos;;document.getElementById(&apos;customBatch&apos;).focus()}else{App.calc.batchSize=parseInt(this.value);document.getElementById(&apos;customBatch&apos;).style.display=&apos;none&apos;;render()}">';
h+='<option value="">Quick Select...</option>';
for(let b=1;b<=10;b++){
h+='<option value="'+b+'"'+(c.batchSize===b&&c.batchSize<=10?' selected':'')+'>'+b+' item'+(b>1?'s':'')+'</option>';
}
h+='<option value="custom"'+(c.batchSize>10?' selected':'')+'>Custom Amount</option>';
h+='</select>';
h+='<input type="number" id="customBatch" class="form-input" placeholder="Enter quantity" value="'+(c.batchSize>10?c.batchSize:'')+'" onchange="App.calc.batchSize=parseInt(this.value)||1;render()" style="display:'+(c.batchSize>10?'block':'none')+'" min="1">';
h+='</div>';
h+='<p style="font-size:.75rem;color:#6b7280">üí° Tip: Enter 1 to calculate cost for selling a single piece (no bulk purchase)</p>';
h+='</div>';
h+='<div class="card"><h2>Details</h2>';
h+='<div class="form-group"><label class="form-label">Product Name</label>';
h+='<input type="text" class="form-input" value="'+c.productName+'" onchange="App.calc.productName=this.value" placeholder="e.g., Fringe Wig 12-14&quot;">';
const invTotal=App.inv.bundles.reduce((s,b)=>s+b.quantity,0)+App.inv.closures.reduce((s,c)=>s+c.quantity,0);
if(invTotal>0){
h+='<p style="font-size:.75rem;color:#059669;margin-top:.25rem">üì¶ You have '+App.inv.bundles.reduce((s,b)=>s+b.quantity,0)+' bundles, '+App.inv.closures.reduce((s,c)=>s+c.quantity,0)+' closures in stock</p>';
}
h+='</div>';
h+='<div class="form-group"><label class="form-label">Materials Price</label><div class="grid-2">';
h+='<input type="number" class="form-input" value="'+c.materialsPrice+'" onchange="App.calc.materialsPrice=this.value;validateInput(this.value,\'materials\')" placeholder="0.00" id="materialsInput">';
h+='<div id="materialsWarning"></div>';
h+='<select class="form-input" onchange="App.calc.materialsCurrency=this.value;render()">';
h+='<option value="usd"'+(c.materialsCurrency==='usd'?' selected':'')+'>USD</option>';
h+='<option value="cad"'+(c.materialsCurrency==='cad'?' selected':'')+'>CAD</option>';
h+='<option value="naira"'+(c.materialsCurrency==='naira'?' selected':'')+'>Naira</option>';
h+='</select></div>';
if(c.productType==='bundles' || c.productType==='factory'){
h+='<small style="color:#6b7280;font-size:.75rem">üí° Enter total price for entire batch of '+c.batchSize+' items</small>';
}else{
h+='<small style="color:#6b7280;font-size:.75rem">üí° Enter price per wig</small>';
}
h+='</div>';
if(c.materialsCurrency==='naira'){
h+='<div class="form-group"><label class="form-label">Custom Naira Rate</label>';
h+='<input type="number" class="form-input" value="'+c.customNairaRate+'" onchange="App.calc.customNairaRate=this.value" placeholder="'+s.exchangeRates.nairaPerCad+'">';
h+='<small style="color:#6b7280;font-size:.75rem">Naira per 1 CAD</small></div>';
}
if(c.productType==='custom'){
h+='<div class="form-group"><label class="form-label">Construction (Naira)</label>';
h+='<input type="number" class="form-input" value="'+(c.constructionCost||s.defaultCosts.nigeriaConstruction)+'" onchange="App.calc.constructionCost=this.value"></div>';
}else{
h+='<div class="form-group"><label class="form-label">Shipping (USD)</label>';
h+='<input type="number" class="form-input" value="'+c.shippingCost+'" onchange="App.calc.shippingCost=this.value" placeholder="'+(c.source==='vietnam'?'65':'35')+'">';
h+='<small style="color:#6b7280;font-size:.75rem">Default: $'+(c.source==='vietnam'?'65':'35')+' USD (will convert to CAD at $'+s.exchangeRates.usdToCad+' rate)</small></div>';
}
h+='<div class="form-group"><label class="form-label">Customs (CAD)</label>';
h+='<input type="number" class="form-input" value="'+(c.customsCost||s.defaultCosts.customsConservative)+'" onchange="App.calc.customsCost=this.value">';
h+='<small style="color:#6b7280;font-size:.75rem">Total, will divide by '+c.batchSize+'</small></div>';
h+='<div class="grid-2">';
h+='<div class="form-group"><label class="form-label">QC (CAD)</label>';
h+='<input type="number" class="form-input" value="'+(c.qcCost||s.defaultCosts.qc)+'" onchange="App.calc.qcCost=this.value"></div>';
h+='<div class="form-group"><label class="form-label">Packaging</label>';
h+='<input type="number" class="form-input" value="'+(c.packagingCost||s.defaultCosts.packaging)+'" onchange="App.calc.packagingCost=this.value"></div>';
h+='</div>';
if(c.productType==='factory'){
h+='<div class="form-group"><label class="form-label">Restyling (Optional)</label>';
h+='<input type="number" class="form-input" value="'+c.restylingCost+'" onchange="App.calc.restylingCost=this.value" placeholder="0.00"></div>';
}
h+='</div>';
h+='<button class="btn btn-primary" onclick="calcCost()">Calculate TRUE COST</button>';
if(c.result){
h+='<div class="card"><h2>Cost Breakdown</h2>';
Object.entries(c.result.breakdown).forEach(([k,v])=>{
h+='<div class="result-row" style="color:#1f2937"><span style="text-transform:capitalize">'+k+'</span><span style="font-weight:600">'+fmt(v)+'</span></div>';
});
h+='</div>';
const p50=c.result.trueCost/0.5;
const p40=c.result.trueCost/0.6;

// Calculate unit costs for different quantities
const totalBatchCost = c.result.trueCost * c.batchSize;
const unitCost = c.result.trueCost;

h+='<div class="result-card"><p>TRUE COST PER ITEM</p><div class="big-number">'+fmt(c.result.trueCost)+'</div>';
h+='<div class="result-details">';
h+='<div class="result-row"><span>At 40% margin:</span><span style="font-weight:700">'+fmt(p40)+'</span></div>';
h+='<div class="result-row"><span>At 50% margin:</span><span style="font-weight:700">'+fmt(p50)+'</span></div>';
h+='</div></div>';

h+='<div class="card"><h2>Pricing Guide</h2>';
h+='<p style="font-size:.875rem;color:#6b7280;margin-bottom:1rem">Recommended selling prices at different margins:</p>';
h+='<div style="background:#f0f9ff;border:2px solid #3b82f6;border-radius:.75rem;padding:1rem;margin-bottom:1rem">';
h+='<h3 style="font-size:1rem;font-weight:700;color:#1e40af;margin-bottom:.75rem">üéØ Custom Margin Calculator</h3>';
h+='<div style="display:flex;gap:.75rem;align-items:end">';
h+='<div style="flex:1"><label style="display:block;font-size:.875rem;color:#6b7280;margin-bottom:.25rem">Enter Your Margin %</label>';
h+='<input type="number" id="customMargin" placeholder="e.g., 35" min="1" max="99" class="form-input" style="margin:0">';
h+='</div>';
h+='<button onclick="calcCustomMargin()" class="btn btn-blue" style="margin:0;padding:.75rem 1.5rem;white-space:nowrap">Calculate</button>';
h+='</div>';
h+='<div id="customMarginResult" style="margin-top:.75rem"></div>';
h+='</div>';
h+='<div style="margin-bottom:.75rem">';
const margins=[
{pct:10,label:'10% - Very Low',color:'#dc2626',desc:'Not viable'},
{pct:15,label:'15% - Too Low',color:'#ef4444',desc:'Unsustainable'},
{pct:20,label:'20% - Risky',color:'#f97316',desc:'Very tight margins'},
{pct:25,label:'25% - Minimal',color:'#fb923c',desc:'Barely workable'},
{pct:30,label:'30% - Low',color:'#f59e0b',desc:'Below recommended'},
{pct:40,label:'40% - Acceptable',color:'#eab308',desc:'Entry level'},
{pct:50,label:'50% - Good',color:'#10b981',desc:'Sustainable ‚≠ê'},
{pct:60,label:'60% - Excellent',color:'#8b5cf6',desc:'Premium positioning'},
{pct:70,label:'70% - Luxury',color:'#6366f1',desc:'High-end market'}
];
margins.forEach(m=>{
const price=c.result.trueCost/(1-m.pct/100);
const profit=price-c.result.trueCost;
h+='<div style="border-left:4px solid '+m.color+';background:#f9fafb;padding:.75rem;border-radius:.5rem;margin-bottom:.75rem">';
h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.25rem">';
h+='<strong style="color:'+m.color+'">'+m.label+'</strong>';
h+='<strong style="font-size:1.125rem">'+fmt(price)+'</strong>';
h+='</div>';
h+='<div style="display:flex;justify-content:space-between;font-size:.875rem;color:#6b7280">';
h+='<span>'+m.desc+'</span>';
h+='<span>Profit: '+fmt(profit)+'</span>';
h+='</div></div>';
});
h+='</div>';
h+='<div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:.75rem;border-radius:.5rem;font-size:.875rem">';
h+='<strong style="color:#92400e">üí° Pricing Tip:</strong><br>';
h+='<span style="color:#92400e">For psychological pricing, try ending in .99 or .95 (e.g., '+fmt(Math.floor(p50)-0.01)+' instead of '+fmt(p50)+')</span>';
h+='</div></div>';
h+='<div class="grid-2">';
h+='<button class="btn btn-white" onclick="saveCalc()">üíæ Save Calculation</button>';
h+='<button class="btn btn-secondary" onclick="saveAsTemplate()">üìã Save as Template</button>';
h+='</div>';
h+='<div class="grid-2" style="margin-bottom:.5rem">';
h+='<button class="btn btn-green" onclick="shareWA()">üí¨ Share</button>';
h+='<button class="btn btn-blue" onclick="copyQ()">üìã Copy</button>';
h+='</div>';
h+='<div class="grid-2">';
h+='<button class="btn btn-secondary btn-sm" onclick="addScenario()">‚ûï Add to Comparison</button>';
h+='<button class="btn btn-secondary btn-sm" onclick="viewScenarios()" id="viewScenariosBtn">üìä Compare ('+scenarios.length+')</button>';
h+='</div>';
}
h+='</div></div>';
}

else if(a.screen==='invoices'){
h='<div class="gradient-bg"><div class="container"><div class="header"><button class="back-btn" onclick="App.nav(\'dashboard\')">‚Üê</button><h1>Invoices</h1><p>'+a.invs.length+' total</p></div>';
h+='<div class="card"><h2>Create Invoice</h2>';
h+='<div class="form-group"><label class="form-label">Customer Name</label>';
h+='<input type="text" class="form-input" value="'+invF.customer+'" onchange="invF.customer=this.value"></div>';
h+='<div class="form-group"><label class="form-label">Email</label>';
h+='<input type="email" class="form-input" value="'+invF.email+'" onchange="invF.email=this.value"></div>';
invF.items.forEach((it,i)=>{
h+='<div class="form-group"><label class="form-label">Item '+(i+1)+'</label>';
h+='<input type="text" class="form-input" value="'+it.desc+'" onchange="invF.items['+i+'].desc=this.value" placeholder="Description" style="margin-bottom:.5rem">';
h+='<div class="grid-2">';
h+='<input type="number" class="form-input" value="'+it.qty+'" onchange="invF.items['+i+'].qty=this.value" placeholder="Qty">';
h+='<input type="number" class="form-input" value="'+it.price+'" onchange="invF.items['+i+'].price=this.value" placeholder="Price">';
h+='</div></div>';
});
h+='<button class="btn btn-secondary btn-sm" onclick="addInvItem()">+ Add Item</button>';
h+='<div class="form-group"><label class="form-label">Shipping</label>';
h+='<input type="number" class="form-input" value="'+invF.shipping+'" onchange="invF.shipping=this.value"></div>';
h+='<button class="btn btn-primary" onclick="saveInv()">Create Invoice</button>';
h+='</div>';
if(a.invs.length>0){
h+='<div class="card"><h2>Recent Invoices</h2>';
a.invs.slice(0,5).forEach(inv=>{
h+='<div style="padding:1rem 0;border-bottom:1px solid #e5e7eb">';
h+='<div style="display:flex;justify-content:space-between;margin-bottom:.5rem">';
h+='<div><strong>'+inv.invoiceNumber+'</strong><br><span style="font-size:.875rem;color:#6b7280">'+inv.customer.name+'</span></div>';
h+='<div style="text-align:right"><strong style="color:#8b5cf6">'+fmt(inv.total)+'</strong><br>';
h+='<span class="badge badge-'+(inv.status==='pending'?'orange':'green')+'">'+inv.status+'</span></div>';
h+='</div>';
h+='<div class="grid-2">';
h+='<button class="btn btn-primary btn-sm" onclick="generateInvoicePDF(App.invs.find(i=>i.id==='+inv.id+'))">üìÑ PDF Invoice</button>';
h+='<button class="btn btn-green btn-sm" onclick="shareInvWA(App.invs.find(i=>i.id==='+inv.id+'))">üí¨ WhatsApp</button>';
h+='</div>';
h+='<div class="grid-2" style="margin-top:.5rem">';
h+='<button class="btn btn-blue btn-sm" onclick="copyInvEmail(App.invs.find(i=>i.id==='+inv.id+'))">üìß Email</button>';
h+='<button class="btn btn-secondary btn-sm" onclick="copyInvSMS(App.invs.find(i=>i.id==='+inv.id+'))">üí¨ SMS</button>';
h+='</div>';
h+='</div>';
});
h+='</div>';
}
h+='</div></div>';
}

else if(a.screen==='inventory'){
const ti=Object.keys(a.inv).reduce((t,k)=>{if(Array.isArray(a.inv[k]))return t+a.inv[k].reduce((s,i)=>s+i.quantity,0);return t},0);
const tv=Object.keys(a.inv).reduce((t,k)=>{if(Array.isArray(a.inv[k]))return t+a.inv[k].reduce((s,i)=>s+(i.quantity*(i.cost||0)),0);return t},0);
const ls=[];
Object.keys(a.inv).forEach(k=>{if(Array.isArray(a.inv[k]))a.inv[k].forEach(i=>{if(i.quantity<=3&&i.quantity>0)ls.push({...i,category:k})})});

h='<div class="gradient-bg"><div class="container"><div class="header"><button class="back-btn" onclick="App.nav(\'dashboard\')">‚Üê</button><h1>Inventory</h1><p>'+ti+' items ‚Ä¢ '+fmt(tv)+' value</p></div>';
if(ls.length>0){
h+='<div class="alert alert-warning"><strong>‚ö†Ô∏è Low Stock Alert</strong><br>'+ls.length+' items need reordering</div>';
}
h+='<div class="grid-3">';
h+='<div class="stat-card"><p>Bundles</p><p style="color:#8b5cf6">'+a.inv.bundles.reduce((s,b)=>s+b.quantity,0)+'</p></div>';
h+='<div class="stat-card"><p>Closures</p><p style="color:#8b5cf6">'+a.inv.closures.reduce((s,c)=>s+c.quantity,0)+'</p></div>';
h+='<div class="stat-card"><p>Wigs</p><p style="color:#8b5cf6">'+a.inv.finishedWigs.reduce((s,w)=>s+w.quantity,0)+'</p></div>';
h+='</div>';
h+='<div class="card"><div class="tabs">';
h+='<button class="tab '+(invTab==='bundles'?'active':'')+'" onclick="invTab=\'bundles\';render()">Bundles</button>';
h+='<button class="tab '+(invTab==='closures'?'active':'')+'" onclick="invTab=\'closures\';render()">Closures</button>';
h+='<button class="tab '+(invTab==='finishedWigs'?'active':'')+'" onclick="invTab=\'finishedWigs\';render()">Wigs</button>';
h+='</div></div>';
h+='<div class="card"><h2>Add Item</h2>';
h+='<input type="text" class="form-input" value="'+invAdd.type+'" onchange="invAdd.type=this.value" placeholder="Description" style="margin-bottom:.5rem">';
h+='<div class="grid-2" style="margin-bottom:.5rem">';
h+='<input type="text" class="form-input" value="'+invAdd.length+'" onchange="invAdd.length=this.value" placeholder="Length">';
h+='<input type="text" class="form-input" value="'+invAdd.texture+'" onchange="invAdd.texture=this.value" placeholder="Texture">';
h+='</div>';
h+='<div class="grid-2" style="margin-bottom:.5rem">';
h+='<input type="number" class="form-input" value="'+invAdd.quantity+'" onchange="invAdd.quantity=this.value" placeholder="Qty">';
h+='<input type="number" class="form-input" value="'+invAdd.cost+'" onchange="invAdd.cost=this.value" placeholder="Cost Each">';
h+='</div>';
h+='<input type="text" class="form-input" value="'+invAdd.supplier+'" onchange="invAdd.supplier=this.value" placeholder="Supplier" style="margin-bottom:.5rem">';
h+='<button class="btn btn-primary" onclick="addInvStock()">Add to Inventory</button>';
h+='</div>';
const ci=a.inv[invTab]||[];
if(ci.length>0){
ci.forEach(i=>{
h+='<div class="card">';
h+='<div style="display:flex;justify-content:space-between;margin-bottom:.5rem">';
h+='<div><strong>'+i.type+'</strong><br><span style="font-size:.875rem;color:#6b7280">'+i.length+(i.texture?' ‚Ä¢ '+i.texture:'')+'</span></div>';
h+='<div style="text-align:right"><strong style="font-size:1.5rem;color:'+(i.quantity<=3?'#f59e0b':'#8b5cf6')+'">'+i.quantity+'</strong><br>';
h+='<span style="font-size:.75rem;color:#6b7280">'+fmt((i.cost||0)*i.quantity)+'</span></div>';
h+='</div>';
if(i.quantity>0){
h+='<div class="grid-2">';
h+='<button class="btn btn-secondary btn-sm" onclick="useInvStock('+i.id+',1)">Use 1</button>';
h+='<button class="btn btn-secondary btn-sm" onclick="delInvStock('+i.id+')">üóëÔ∏è Delete</button>';
h+='</div>';
}
if(i.quantity<=3&&i.quantity>0){
h+='<div class="alert alert-warning" style="margin-top:.5rem;font-size:.75rem">‚ö†Ô∏è Low stock</div>';
}
h+='</div>';
});
}else{
h+='<div class="card" style="text-align:center;padding:2rem"><p style="color:#6b7280;margin-bottom:1rem">No items in inventory</p></div>';
}
h+='</div></div>';
}

else if(a.screen==='analytics'){
const tm=new Date();
const tmC=a.calcs.filter(c=>{const d=new Date(c.date);return d.getMonth()===tm.getMonth()&&d.getFullYear()===tm.getFullYear()});
const ac=a.calcs.length>0?a.calcs.reduce((s,c)=>s+(c.trueCost||0),0)/a.calcs.length:0;
const ti=a.invs.reduce((s,i)=>s+i.total,0);
const tp=a.invs.filter(i=>i.status==='paid').reduce((s,i)=>s+i.total,0);

h='<div class="gradient-bg"><div class="container"><div class="header"><button class="back-btn" onclick="App.nav(\'dashboard\')">‚Üê</button><h1>Analytics</h1><p>Business insights</p></div>';
h+='<div class="grid-2">';
h+='<div class="stat-card"><p>Calculations</p><p style="color:#8b5cf6">'+a.calcs.length+'</p></div>';
h+='<div class="stat-card"><p>Avg Cost</p><p style="color:#8b5cf6">'+fmt(ac)+'</p></div>';
h+='<div class="stat-card"><p>Invoiced</p><p style="color:#10b981">'+fmt(ti)+'</p></div>';
h+='<div class="stat-card"><p>Paid</p><p style="color:#10b981">'+fmt(tp)+'</p></div>';
h+='</div>';
h+='<div class="card"><h2>This Month</h2>';
h+='<div class="result-row" style="color:#1f2937"><span>Calculations:</span><strong>'+tmC.length+'</strong></div>';
h+='<div class="result-row" style="color:#1f2937"><span>Invoices:</span><strong>'+a.invs.filter(i=>{const d=new Date(i.date);return d.getMonth()===tm.getMonth()&&d.getFullYear()===tm.getFullYear()}).length+'</strong></div>';
h+='</div>';
h+='<div class="card"><h2>Product Types</h2>';
['custom','factory','bundles'].forEach(t=>{
const c=a.calcs.filter(ca=>ca.productType===t).length;
const p=a.calcs.length>0?(c/a.calcs.length*100):0;
h+='<div class="result-row" style="color:#1f2937;margin-bottom:.5rem"><span style="text-transform:capitalize">'+t+'</span><span>'+c+' ('+p.toFixed(0)+'%)</span></div>';
h+='<div style="width:100%;height:.5rem;background:#e5e7eb;border-radius:.25rem;margin-bottom:1rem"><div style="width:'+p+'%;height:100%;background:#8b5cf6;border-radius:.25rem"></div></div>';
});
h+='</div>';
h+='<div class="card"><h2>Export Data</h2>';
h+='<button class="btn btn-primary" onclick="exportData()">üì• Download JSON</button>';
h+='</div>';
h+='</div></div>';
}


else if(a.screen==='mixed'){
const mb=App.mixedBatch;
const s=App.settings;
h='<div class="gradient-bg"><div class="container"><div class="header"><button class="back-btn" onclick="App.nav(\'dashboard\')">‚Üê</button><h1>Mixed Batch</h1><p>Calculate costs for multiple item types in one shipment</p></div>';

// Shared costs section
h+='<div class="card">';
h+='<h2>Shared Shipping Costs</h2>';
h+='<p style="font-size:.875rem;color:#6b7280;margin-bottom:1rem">These costs will be divided equally across all items</p>';
h+='<div class="form-group"><label class="form-label">Source</label>';
h+='<div class="grid-2">';
h+='<button class="btn '+(mb.sharedCosts.source==='china'?'btn-primary':'btn-secondary')+'" onclick="App.mixedBatch.sharedCosts.source=\'china\';render()">üá®üá≥ China</button>';
h+='<button class="btn '+(mb.sharedCosts.source==='vietnam'?'btn-primary':'btn-secondary')+'" onclick="App.mixedBatch.sharedCosts.source=\'vietnam\';render()">üáªüá≥ Vietnam</button>';
h+='</div></div>';
h+='<div class="grid-2">';
h+='<div class="form-group"><label class="form-label">Shipping (USD)</label>';
h+='<input type="number" class="form-input" value="'+mb.sharedCosts.shipping+'" onchange="App.mixedBatch.sharedCosts.shipping=this.value" placeholder="'+(mb.sharedCosts.source==='vietnam'?'65':'35')+'">';
h+='</div>';
h+='<div class="form-group"><label class="form-label">Customs (CAD)</label>';
h+='<input type="number" class="form-input" value="'+mb.sharedCosts.customs+'" onchange="App.mixedBatch.sharedCosts.customs=this.value" placeholder="27">';
h+='</div>';
h+='</div></div>';

// Add item form
h+='<div class="card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff">';
h+='<h2 style="color:#fff">‚ûï Add Item to Batch</h2>';
h+='<div class="form-group"><label class="form-label" style="color:#fff">Item Type</label>';
h+='<select class="form-input" onchange="mixedItemForm.type=this.value;render()">';
h+='<option value="wig"'+(mixedItemForm.type==='wig'?' selected':'')+'>Wig</option>';
h+='<option value="bundle"'+(mixedItemForm.type==='bundle'?' selected':'')+'>Bundle</option>';
h+='<option value="closure"'+(mixedItemForm.type==='closure'?' selected':'')+'>Closure</option>';
h+='</select></div>';
h+='<div class="form-group"><label class="form-label" style="color:#fff">Item Name</label>';
h+='<input type="text" class="form-input" value="'+mixedItemForm.name+'" onchange="mixedItemForm.name=this.value" placeholder="e.g., Fringe Wig 14&quot;">';
h+='</div>';
h+='<div class="grid-2">';
h+='<div class="form-group"><label class="form-label" style="color:#fff">Quantity</label>';
h+='<input type="number" class="form-input" value="'+mixedItemForm.quantity+'" onchange="mixedItemForm.quantity=this.value" min="1">';
h+='</div>';
h+='<div class="form-group"><label class="form-label" style="color:#fff">Materials Price</label>';
h+='<input type="number" class="form-input" value="'+mixedItemForm.materialsPrice+'" onchange="mixedItemForm.materialsPrice=this.value" placeholder="0.00">';
h+='</div>';
h+='</div>';
h+='<div class="form-group"><label class="form-label" style="color:#fff">Currency</label>';
h+='<select class="form-input" onchange="mixedItemForm.materialsCurrency=this.value">';
h+='<option value="usd"'+(mixedItemForm.materialsCurrency==='usd'?' selected':'')+'>USD</option>';
h+='<option value="cad"'+(mixedItemForm.materialsCurrency==='cad'?' selected':'')+'>CAD</option>';
h+='</select></div>';
h+='<button class="btn btn-white" onclick="addMixedItem()" style="width:100%">Add Item</button>';
h+='</div>';

// Items in batch
if(mb.items.length>0){
const totalQty=mb.items.reduce((s,i)=>s+i.quantity,0);
h+='<div class="card">';
h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">';
h+='<h2 style="margin:0">Items in Batch ('+totalQty+' total)</h2>';
h+='<button class="btn btn-sm" style="background:#fee2e2;color:#dc2626" onclick="clearMixedBatch()">Clear All</button>';
h+='</div>';
mb.items.forEach(item=>{
h+='<div style="background:#f9fafb;border:2px solid #e5e7eb;border-radius:.5rem;padding:1rem;margin-bottom:.75rem">';
h+='<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:.5rem">';
h+='<div>';
h+='<div style="font-weight:700;color:#1f2937;margin-bottom:.25rem">'+item.name+'</div>';
h+='<div style="font-size:.875rem;color:#6b7280">'+item.type.charAt(0).toUpperCase()+item.type.slice(1)+' ‚Ä¢ Qty: '+item.quantity+'</div>';
h+='</div>';
h+='<button onclick="removeMixedItem('+item.id+')" style="background:#fee2e2;color:#dc2626;border:none;padding:.5rem;border-radius:.5rem;cursor:pointer">üóëÔ∏è</button>';
h+='</div>';
h+='<div style="display:flex;justify-content:space-between;font-size:.875rem">';
h+='<span style="color:#6b7280">Materials:</span>';
h+='<span style="font-weight:600">'+fmt(item.materialsPrice)+' '+item.materialsCurrency.toUpperCase()+'</span>';
h+='</div>';
h+='</div>';
});
h+='<button class="btn btn-primary" onclick="calcMixedBatch()" style="width:100%;margin-top:1rem">Calculate Mixed Batch</button>';
h+='</div>';
}

// Results
if(mb.result){
h+='<div class="result-card"><p>BATCH SUMMARY</p><div class="big-number">'+fmt(mb.result.totalBatchCost)+'</div>';
h+='<div class="result-details">';
h+='<div class="result-row"><span>Total items:</span><span style="font-weight:700">'+mb.result.totalItems+'</span></div>';
h+='<div class="result-row"><span>Average per item:</span><span style="font-weight:700">'+fmt(mb.result.avgCostPerItem)+'</span></div>';
h+='<div class="result-row"><span>Shipping per item:</span><span style="font-weight:700">'+fmt(mb.result.shippingPerItem)+'</span></div>';
h+='<div class="result-row"><span>Customs per item:</span><span style="font-weight:700">'+fmt(mb.result.customsPerItem)+'</span></div>';
h+='</div></div>';

h+='<div class="card">';
h+='<h2>Cost Breakdown by Item Type</h2>';
mb.result.items.forEach(item=>{
const p50=item.perUnitCost/0.5;
h+='<div style="background:#f9fafb;border-left:4px solid #8b5cf6;padding:1rem;margin-bottom:1rem;border-radius:.5rem">';
h+='<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:.75rem">';
h+='<div>';
h+='<div style="font-weight:700;font-size:1.125rem;color:#1f2937">'+item.name+'</div>';
h+='<div style="font-size:.875rem;color:#6b7280">'+item.quantity+' √ó '+item.type+'</div>';
h+='</div>';
h+='<div style="text-align:right">';
h+='<div style="font-size:1.25rem;font-weight:700;color:#8b5cf6">'+fmt(item.perUnitCost)+'<span style="font-size:.875rem;font-weight:400;color:#6b7280">/unit</span></div>';
h+='<div style="font-size:.875rem;color:#6b7280">'+fmt(item.totalCost)+' total</div>';
h+='</div>';
h+='</div>';
h+='<div style="font-size:.875rem;line-height:1.6">';
h+='<div style="display:flex;justify-content:space-between;padding:.25rem 0"><span style="color:#6b7280">Materials:</span><span>'+fmt(item.materialsPerUnit)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:.25rem 0"><span style="color:#6b7280">Shipping:</span><span>'+fmt(item.shippingPerUnit)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:.25rem 0"><span style="color:#6b7280">Customs:</span><span>'+fmt(item.customsPerUnit)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:.25rem 0"><span style="color:#6b7280">QC:</span><span>'+fmt(item.qcPerUnit)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:.25rem 0"><span style="color:#6b7280">Packaging:</span><span>'+fmt(item.packagingPerUnit)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:.25rem 0"><span style="color:#6b7280">Contingency:</span><span>'+fmt(item.contingencyPerUnit)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:.5rem 0;margin-top:.5rem;border-top:2px solid #e5e7eb"><span style="font-weight:700">Sell @ 50%:</span><span style="font-weight:700;color:#10b981">'+fmt(p50)+'</span></div>';
h+='</div>';
h+='</div>';
});
h+='</div>';

h+='<div class="grid-2">';
h+='<button class="btn btn-white" onclick="saveMixedBatch()">üíæ Save Batch</button>';
h+='<button class="btn btn-secondary" onclick="clearMixedBatch()">üîÑ New Batch</button>';
h+='</div>';
}

h+='</div></div>';
}
else if(a.screen==='settings'){
h='<div class="gradient-bg"><div class="container"><div class="header"><button class="back-btn" onclick="App.nav(\'dashboard\')">‚Üê</button><h1>Settings</h1><p>Configure defaults</p></div>';
h+='<div class="card"><h2>Exchange Rates</h2>';
h+='<div class="form-group"><label class="form-label">USD to CAD</label>';
h+='<input type="number" class="form-input" value="'+a.settings.exchangeRates.usdToCad+'" onchange="App.settings.exchangeRates.usdToCad=parseFloat(this.value);App.save()"></div>';
h+='<div class="form-group"><label class="form-label">Naira per CAD</label>';
h+='<input type="number" class="form-input" value="'+a.settings.exchangeRates.nairaPerCad+'" onchange="App.settings.exchangeRates.nairaPerCad=parseFloat(this.value);App.save()"></div>';
h+='</div>';
h+='<div class="card"><h2>About</h2><p style="margin-bottom:.5rem">Dehjiluxe Business Manager v2.0</p>';
h+='<p style="font-size:.875rem;color:#6b7280">Progressive Web App</p></div>';
h+='</div></div>';
}

$('#app').innerHTML=h;
renderNav();
}

function ac(i,t,d,s){
return '<div class="action-card" onclick="App.nav(\''+s+'\')"><div class="action-content"><div class="action-icon">'+i+'</div><div class="action-text"><h3>'+t+'</h3><p>'+d+'</p></div></div><div class="action-arrow">‚Üí</div></div>';
}

function renderNav(){
const existingNav=document.querySelector('.bottom-nav');
if(existingNav)existingNav.remove();
const existingOverlay=document.querySelector('.overlay');
if(existingOverlay)existingOverlay.remove();
const existingMenu=document.querySelector('.more-menu');
if(existingMenu)existingMenu.remove();

const n=['dashboard','calculator','more'];
const a=App.screen;
let h='<div class="bottom-nav">';
n.forEach(i=>{
const ic={'dashboard':'üè†','calculator':'üßÆ','more':'‚ãØ'}[i];
h+='<button class="nav-item '+(a===i?'active':'')+'" onclick="'+(i==='more'?'App.showMore=!App.showMore;render()':'App.nav(\''+i+'\')')+'"><div class="nav-icon">'+ic+'</div><span>'+i.charAt(0).toUpperCase()+i.slice(1)+'</span></button>';
});
h+='</div>';
if(App.showMore){
h+='<div class="overlay" onclick="App.showMore=false;render()"></div>';
h+='<div class="more-menu"><div class="more-grid">';
const mi=[['mixed','üéØ','Mixed Batch'],['inventory','üì¶','Inventory'],['invoices','üìÑ','Invoices'],['analytics','üìä','Analytics'],['settings','‚öôÔ∏è','Settings']];
mi.forEach(([s,i,l])=>{
h+='<button class="more-item" onclick="App.nav(\''+s+'\')"><span>'+i+'</span><span>'+l+'</span></button>';
});
h+='</div></div>';
}
document.body.insertAdjacentHTML('beforeend',h);
}

function loadP(p){
const pr={'fringe':{name:'Fringe Wig',materialsUSD:71},'brown':{name:'Brown Darkroot Wig',materialsUSD:86}}[p];
App.calc.productName=pr.name;
App.calc.materialsPrice=pr.materialsUSD;
App.calc.materialsCurrency='usd';
App.calc.productType='custom';
App.calc.source='nigeria';
render();
}


function calcCustomMargin(){
const marginInput=$('#customMargin');
if(!marginInput)return;
const margin=parseFloat(marginInput.value);
if(!margin||margin<1||margin>99){
$('#customMarginResult').innerHTML='<p style="color:#dc2626;font-size:.875rem;margin-top:.5rem">‚ö†Ô∏è Please enter a margin between 1% and 99%</p>';
return;
}
const cost=App.calc.result.trueCost;
const price=cost/(1-margin/100);
const profit=price-cost;
let assessment='';
let color='#6b7280';
if(margin<20){assessment='‚ö†Ô∏è Very risky - not recommended';color='#dc2626'}
else if(margin<30){assessment='‚ö° Low margin - tight budget';color='#f97316'}
else if(margin<40){assessment='üìä Below standard';color='#f59e0b'}
else if(margin<50){assessment='‚úì Acceptable margin';color='#eab308'}
else if(margin<60){assessment='‚úì‚úì Good margin';color='#10b981'}
else if(margin<70){assessment='‚≠ê Excellent margin';color='#8b5cf6'}
else{assessment='üíé Premium/Luxury pricing';color='#6366f1'}
$('#customMarginResult').innerHTML='<div style="background:white;border:2px solid '+color+';border-radius:.5rem;padding:.75rem;margin-top:.75rem"><div style="display:flex;justify-content:space-between;margin-bottom:.5rem"><strong style="color:'+color+'">'+margin+'% Margin</strong><strong style="font-size:1.25rem;color:'+color+'">'+fmt(price)+'</strong></div><div style="display:flex;justify-content:space-between;font-size:.875rem;color:#6b7280"><span>'+assessment+'</span><span>Profit: '+fmt(profit)+'</span></div></div>';
}

// PRIORITY 1 & 3 FEATURES

// Auto-save calculator state
function autoSaveCalc(){
S.save('calcAutoSave',App.calc);
}

// Restore auto-saved state
function restoreAutoSave(){
const saved=S.load('calcAutoSave',null);
if(saved&&saved.productName){
if(confirm('Resume your last calculation for "'+saved.productName+'"?')){
App.calc=saved;
render();
}
}
}

// Save as template
function saveAsTemplate(){
const c=App.calc;
if(!c.productName){
alert('‚ùå Please enter a product name first');
return;
}
const name=prompt('Template name:',c.productName+' Template');
if(!name)return;
const templates=S.load('templates',[]);
const template={
id:Date.now(),
name:name,
createdDate:new Date().toISOString(),
config:{
productType:c.productType,
source:c.source,
batchSize:c.batchSize,
productName:c.productName,
materialsPrice:c.materialsPrice,
materialsCurrency:c.materialsCurrency,
customNairaRate:c.customNairaRate,
shippingCost:c.shippingCost,
customsCost:c.customsCost,
qcCost:c.qcCost,
packagingCost:c.packagingCost,
restylingCost:c.restylingCost,
constructionCost:c.constructionCost
}
};
templates.push(template);
S.save('templates',templates);
alert('‚úÖ Template "'+name+'" saved!');
render();
}

// Load template
function loadTemplate(id){
const templates=S.load('templates',[]);
const template=templates.find(t=>t.id===id);
if(!template)return;
Object.assign(App.calc,template.config);
App.calc.result=null;
render();
}

// Delete template
function deleteTemplate(id){
if(!confirm('Delete this template?'))return;
let templates=S.load('templates',[]);
templates=templates.filter(t=>t.id!==id);
S.save('templates',templates);
render();
}

// Input validation
function validateInput(value,type){
const val=parseFloat(value);
let warning='';
if(type==='materials'){
if(val>500){
warning='<p style="color:#f59e0b;font-size:.75rem;margin-top:.25rem">‚ö†Ô∏è $'+val+' seems high - did you mean $'+(val/10).toFixed(2)+'?</p>';
}else if(val>0&&val<10){
warning='<p style="color:#3b82f6;font-size:.75rem;margin-top:.25rem">‚ÑπÔ∏è Very low material cost - double check this is correct</p>';
}
const w=$('#materialsWarning');
if(w)w.innerHTML=warning;
}
}

// Generate PDF Invoice using HTML Canvas
function generateInvoicePDF(invoice){
// Create a printable HTML invoice
const invoiceHTML=`
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}
.header{display:flex;justify-content:space-between;margin-bottom:40px;border-bottom:3px solid #667eea;padding-bottom:20px}
.company{color:#667eea}
.company h1{margin:0;font-size:32px}
.company p{margin:5px 0;color:#666}
.invoice-info{text-align:right}
.invoice-info h2{margin:0;color:#333;font-size:24px}
.invoice-info p{margin:5px 0;color:#666}
.bill-to{margin-bottom:30px}
.bill-to h3{color:#667eea;margin-bottom:10px}
.bill-to p{margin:3px 0;color:#333}
table{width:100%;border-collapse:collapse;margin-bottom:30px}
thead{background:#667eea;color:white}
th,td{padding:12px;text-align:left;border-bottom:1px solid #e5e7eb}
th{font-weight:600}
.amount{text-align:right}
.total-section{text-align:right;margin-top:20px}
.total-row{display:flex;justify-content:flex-end;margin:8px 0;font-size:14px}
.total-row.grand{font-size:18px;font-weight:bold;color:#667eea;margin-top:15px;padding-top:15px;border-top:2px solid #e5e7eb}
.total-label{width:150px;text-align:right;padding-right:20px}
.total-value{width:120px;text-align:right}
.footer{margin-top:50px;padding-top:20px;border-top:1px solid #e5e7eb;color:#666;font-size:12px}
.footer p{margin:5px 0}
@media print{body{padding:0}}
</style>
</head>
<body>
<div class="header">
<div class="company">
<h1>Dehjiluxe</h1>
<p>Premium Hair Extensions</p>
<p>info@dehjiluxe.com</p>
</div>
<div class="invoice-info">
<h2>INVOICE</h2>
<p><strong>${invoice.invoiceNumber}</strong></p>
<p>${new Date(invoice.date).toLocaleDateString()}</p>
</div>
</div>

<div class="bill-to">
<h3>Bill To:</h3>
<p><strong>${invoice.customer.name}</strong></p>
${invoice.customer.email?'<p>'+invoice.customer.email+'</p>':''}
${invoice.customer.address?'<p>'+invoice.customer.address+'</p>':''}
</div>

<table>
<thead>
<tr>
<th>Description</th>
<th class="amount">Qty</th>
<th class="amount">Unit Price</th>
<th class="amount">Total</th>
</tr>
</thead>
<tbody>
${invoice.items.map(item=>'<tr><td>'+item.description+'</td><td class="amount">'+item.quantity+'</td><td class="amount">'+fmt(item.unitPrice)+'</td><td class="amount">'+fmt(item.total)+'</td></tr>').join('')}
${invoice.shipping>0?'<tr><td colspan="3" style="text-align:right;padding-right:20px"><strong>Shipping</strong></td><td class="amount">'+fmt(invoice.shipping)+'</td></tr>':''}
</tbody>
</table>

<div class="total-section">
<div class="total-row"><div class="total-label">Subtotal:</div><div class="total-value">'+fmt(invoice.subtotal)+'</div></div>
${invoice.shipping>0?'<div class="total-row"><div class="total-label">Shipping:</div><div class="total-value">'+fmt(invoice.shipping)+'</div></div>':''}
<div class="total-row grand"><div class="total-label">TOTAL:</div><div class="total-value">'+fmt(invoice.total)+'</div></div>
</div>

<div class="footer">
<p><strong>Payment Terms:</strong> Due within 14 days</p>
<p><strong>Payment Methods:</strong> E-transfer, Cash</p>
<p>Thank you for your business!</p>
</div>
</body>
</html>
`;

// Open in new window for printing/saving as PDF
const printWindow=window.open('','_blank');
printWindow.document.write(invoiceHTML);
printWindow.document.close();

// Auto-trigger print dialog after a brief delay
setTimeout(()=>{
printWindow.focus();
printWindow.print();
},500);

// Inform user
alert('‚úÖ Invoice opened in new window!\n\nUse File ‚Üí Print ‚Üí Save as PDF to download\n\nOr use File ‚Üí Save Page As for HTML version');
}



// Check for duplicates
function checkDuplicate(){
if(!App.calc.productName)return;
const today=new Date().toDateString();
const existing=App.calcs.find(c=>
c.name===App.calc.productName&&
new Date(c.date).toDateString()===today
);
if(existing){
const msg='‚ö†Ô∏è You calculated "'+App.calc.productName+'" today at '+fmt(existing.trueCost)+'.\n\nCalculate again anyway?';
return confirm(msg);
}
return true;
}



// Search calculations
let searchTerm='';
function searchCalcs(term){
searchTerm=term.toLowerCase();
render();
}

function getFilteredCalcs(){
if(!searchTerm)return App.calcs;
return App.calcs.filter(c=>
c.name.toLowerCase().includes(searchTerm)||
c.description.toLowerCase().includes(searchTerm)
);
}

// Scenario comparison
let scenarios=[];
function addScenario(){
if(!App.calc.result){
alert('Calculate a cost first');
return;
}
const s={
id:Date.now(),
name:App.calc.productName||'Scenario '+(scenarios.length+1),
batchSize:App.calc.batchSize,
source:App.calc.source,
trueCost:App.calc.result.trueCost,
breakdown:App.calc.result.breakdown
};
scenarios.push(s);
alert('‚úÖ Scenario added to comparison');
}

function clearScenarios(){
scenarios=[];
}

function viewScenarios(){
if(scenarios.length<2){
alert('Add at least 2 scenarios to compare');
return;
}
let h='<div style="background:#fff;padding:1rem;border-radius:.5rem;max-height:80vh;overflow-y:auto">';
h+='<h3 style="margin-bottom:1rem">Scenario Comparison</h3>';
h+='<table style="width:100%;font-size:.875rem">';
h+='<tr style="background:#f3f4f6"><th style="padding:.5rem;text-align:left">Scenario</th><th>Batch</th><th>Source</th><th>TRUE COST</th></tr>';
scenarios.forEach(s=>{
h+='<tr style="border-bottom:1px solid #e5e7eb"><td style="padding:.5rem">'+s.name+'</td><td>'+s.batchSize+'</td><td>'+s.source+'</td><td><strong>'+fmt(s.trueCost)+'</strong></td></tr>';
});
h+='</table>';
const best=scenarios.reduce((min,s)=>s.trueCost<min.trueCost?s:min,scenarios[0]);
h+='<p style="margin-top:1rem;padding:1rem;background:#d1fae5;border-radius:.5rem"><strong>‚úÖ Best Option:</strong> '+best.name+' at '+fmt(best.trueCost)+'</p>';
h+='<button onclick="closeModal()" style="margin-top:1rem;width:100%;padding:.75rem;background:#8b5cf6;color:#fff;border:none;border-radius:.5rem;font-weight:700">Close</button>';
h+='</div>';
showModal(h);
}

// Reload a saved calculation
function reloadCalc(id){
const calc=App.calcs.find(c=>c.id===id);
if(!calc)return;
if(confirm('Load "'+calc.name+'" into calculator?')){
App.calc.productName=calc.name;
App.calc.productType=calc.productType;
App.calc.source=calc.source;
App.calc.batchSize=calc.batchSize;
App.calc.result=null;
App.nav('calculator');
}
}

function showModal(content){
const m=document.createElement('div');
m.id='modalOverlay';
m.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:flex;align-items:center;justify-content:center;padding:1rem';
m.innerHTML=content;
m.onclick=(e)=>{if(e.target===m)closeModal()};
document.body.appendChild(m);
}

function closeModal(){
const m=$('#modalOverlay');
if(m)m.remove();
}

// MIXED BATCH CALCULATOR
let mixedItemForm={type:'wig',name:'',quantity:1,materialsPrice:'',materialsCurrency:'usd'};

function addMixedItem(){
const f=mixedItemForm;
if(!f.name||!f.materialsPrice){
alert('‚ùå Enter item name and materials price');
return;
}
if(!f.quantity||f.quantity<1){
alert('‚ùå Quantity must be at least 1');
return;
}
const item={
id:Date.now(),
type:f.type,
name:f.name,
quantity:parseInt(f.quantity),
materialsPrice:parseFloat(f.materialsPrice),
materialsCurrency:f.materialsCurrency
};
App.mixedBatch.items.push(item);
// Reset form
mixedItemForm={type:'wig',name:'',quantity:1,materialsPrice:'',materialsCurrency:'usd'};
render();
}

function removeMixedItem(id){
App.mixedBatch.items=App.mixedBatch.items.filter(i=>i.id!==id);
App.mixedBatch.result=null;
render();
}

function calcMixedBatch(){
const mb=App.mixedBatch;
const s=App.settings;
if(mb.items.length===0){
alert('‚ùå Add at least one item to the batch');
return;
}
if(!mb.sharedCosts.shipping){
alert('‚ùå Enter shipping cost');
return;
}

// Calculate total items
const totalQty=mb.items.reduce((sum,item)=>sum+item.quantity,0);

// Convert shipping to CAD
let shippingCAD=parseFloat(mb.sharedCosts.shipping)*s.exchangeRates.usdToCad;
let customsCAD=parseFloat(mb.sharedCosts.customs||s.defaultCosts.customsConservative);

// Shared costs per item
const shippingPerItem=shippingCAD/totalQty;
const customsPerItem=customsCAD/totalQty;

// Calculate each item type
const results=[];
let totalBatchCost=0;

mb.items.forEach(item=>{
// Convert materials to CAD
let materialsCAD=item.materialsPrice;
if(item.materialsCurrency==='usd'){
materialsCAD=item.materialsPrice*s.exchangeRates.usdToCad;
}else if(item.materialsCurrency==='naira'){
materialsCAD=item.materialsPrice/s.exchangeRates.nairaPerCad;
}

// Materials per unit (total materials for this item √∑ quantity)
const materialsPerUnit=materialsCAD/item.quantity;

// Individual costs based on item type
let qcCost=0,packagingCost=0;
if(item.type==='wig'){
qcCost=s.defaultCosts.qc;
packagingCost=s.defaultCosts.packaging;
}else if(item.type==='bundle'){
qcCost=s.defaultCosts.qc;
packagingCost=s.defaultCosts.packaging;
}else if(item.type==='closure'){
qcCost=4; // Lower QC cost for closures
packagingCost=2; // Lower packaging for closures
}

// Calculate per-unit cost
const perUnitSubtotal=materialsPerUnit+shippingPerItem+customsPerItem+qcCost+packagingCost;
const perUnitContingency=perUnitSubtotal*s.defaultCosts.contingency;
const perUnitCost=perUnitSubtotal+perUnitContingency;

// Total for this item type
const itemTotal=perUnitCost*item.quantity;
totalBatchCost+=itemTotal;

results.push({
id:item.id,
name:item.name,
type:item.type,
quantity:item.quantity,
materialsPerUnit:materialsPerUnit,
shippingPerUnit:shippingPerItem,
customsPerUnit:customsPerItem,
qcPerUnit:qcCost,
packagingPerUnit:packagingCost,
contingencyPerUnit:perUnitContingency,
perUnitCost:perUnitCost,
totalCost:itemTotal
});
});

mb.result={
items:results,
totalItems:totalQty,
totalBatchCost:totalBatchCost,
avgCostPerItem:totalBatchCost/totalQty,
shippingPerItem:shippingPerItem,
customsPerItem:customsPerItem
};

render();
}

function saveMixedBatch(){
const mb=App.mixedBatch;
if(!mb.result){
alert('‚ùå Calculate the batch first');
return;
}

const calc={
id:Date.now(),
date:new Date().toISOString(),
type:'mixed',
name:'Mixed Batch - '+mb.items.length+' item types',
description:mb.items.map(i=>i.quantity+'√ó '+i.name).join(', '),
items:mb.result.items,
totalItems:mb.result.totalItems,
totalBatchCost:mb.result.totalBatchCost,
avgCostPerItem:mb.result.avgCostPerItem
};

App.calcs.unshift(calc);
App.save();
alert('‚úÖ Mixed batch saved!');

// Reset
App.mixedBatch={items:[],sharedCosts:{shipping:'',customs:'',source:'china'},result:null};
App.nav('dashboard');
}

function clearMixedBatch(){
if(confirm('Clear all items from batch?')){
App.mixedBatch={items:[],sharedCosts:{shipping:'',customs:'',source:'china'},result:null};
render();
}
}

function exportData(){
const d={calculations:App.calcs,invoices:App.invs,inventory:App.inv,exportDate:new Date().toISOString()};
const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
const u=URL.createObjectURL(b);
const a=document.createElement('a');
a.href=u;
a.download='dehjiluxe-data-'+new Date().toISOString().split('T')[0]+'.json';
a.click();
}

// Initialize
render();
// Restore auto-saved calculation if exists
setTimeout(restoreAutoSave,500);

// Install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{
e.preventDefault();
deferredPrompt=e;
console.log('App can be installed');
});

console.log('‚úÖ Dehjiluxe PWA loaded successfully!');
</script>
</body>
</html>
